/***************************************
 * Delivery Overview â€“ Apps Script (FULL)
 * - Login (master + supplier)
 * - Orders list (master: all, supplier: own)
 * - Update tracking
 * - Create order (master): DropshipmentOrder + SurfcenterOrder
 * - Completed TRUE/FALSE (master)
 * - Suppliers list
 * - Templates:
 *    - Mail templates (independent): ID | Language | Label | Subject | Body  (max 10)
 *    - Customer:                   ID | Language | Label | Subject | Body
 *    - Supplier:                   ID | Language | Label | Subject | Body
 * - Mail log: Timestamp | RowID | Customer | OrderID | To | Kind | Language | Template | Subject
 ***************************************/

const SHEET_NAME = "Sheet1";
const SUPPLIERS_SHEET = "Suppliers";
const MASTER_KEY = "SC76";

// Templates sheets
const INDEP_TPL_SHEET = "Mail templates";
const CUSTOMER_TPL_SHEET = "Customer";
const SUPPLIER_TPL_SHEET = "Supplier";

// Mail log sheet
const MAIL_LOG_SHEET = "Mail log";

// Orders headers
const H = {
  customer: "Customer",
  mailCustomer: "Mail Customer",
  supplier: "Supplier",
  supplierKey: "Supplier KEY",

  carrier: "Carrier",
  trackingNumber: "Trackingnumber",
  trackingLink: "Trackinglink",

  dropOrder: "Dropshipment order",
  surfOrder: "Surfcenter order",

  completed: "Completed",
};

function doGet(e) {
  try {
    const action = String(e?.parameter?.action || "").toLowerCase();

    // Core
    if (action === "auth") return authGet_(e);
    if (action === "suppliers") return listSuppliers_(e);
    if (action === "orders") return listOrders_(e);
    if (action === "update") return updateTrackingGet_(e);
    if (action === "create") return createOrderGet_(e);
    if (action === "complete") return setCompletedGet_(e);

    // Templates
    if (action === "indep_templates") return listTemplates_(e, INDEP_TPL_SHEET);
    if (action === "indep_upsert") return upsertTemplate_(e, INDEP_TPL_SHEET, 10);

    if (action === "customer_templates") return listTemplates_(e, CUSTOMER_TPL_SHEET);
    if (action === "customer_upsert") return upsertTemplate_(e, CUSTOMER_TPL_SHEET, null);

    if (action === "supplier_templates") return listTemplates_(e, SUPPLIER_TPL_SHEET);
    if (action === "supplier_upsert") return upsertTemplate_(e, SUPPLIER_TPL_SHEET, null);

    // Mail log
    if (action === "log_mail") return logMail_(e);
    if (action === "mail_log") return listMailLog_(e);

    return output_({ ok: false, error: "Unknown action", gotAction: action }, e);
  } catch (err) {
    return output_({ ok: false, error: String(err && err.message ? err.message : err) }, e);
  }
}

/* =========================
 * AUTH
 * ========================= */
function authGet_(e) {
  const supplierKey = String(e?.parameter?.supplierKey || "").trim();
  if (!supplierKey) return output_({ ok: false, error: "Missing supplierKey" }, e);

  if (supplierKey === MASTER_KEY) {
    return output_({ ok: true, supplier: "ALL" }, e);
  }

  const supplierName = findSupplierByKey_(supplierKey);
  if (supplierName) return output_({ ok: true, supplier: supplierName }, e);

  return output_({ ok: false, error: "Invalid key" }, e);
}

/* =========================
 * SUPPLIERS
 * ========================= */
function listSuppliers_(e) {
  const sh = suppliersSheet_();
  const values = sh.getDataRange().getValues();
  if (values.length < 2) return output_({ ok: true, suppliers: [], mailMap: {}, keyMap: {} }, e);

  const suppliers = [];
  const mailMap = {};
  const keyMap = {};

  for (let i = 1; i < values.length; i++) {
    const supplier = String(values[i][0] || "").trim(); // A
    const mail = String(values[i][1] || "").trim();     // B
    const key = String(values[i][2] || "").trim();      // C
    if (!supplier) continue;

    suppliers.push(supplier);
    if (mail) mailMap[supplier.toLowerCase()] = mail;
    if (key) keyMap[supplier.toLowerCase()] = key;
  }

  return output_({ ok: true, suppliers, mailMap, keyMap }, e);
}

/* =========================
 * LIST ORDERS
 * ========================= */
function listOrders_(e) {
  const supplierRaw = String(e?.parameter?.supplier || "").trim();
  if (!supplierRaw) return output_({ ok: false, error: "Missing supplier" }, e);

  const supplierLower = supplierRaw.toLowerCase();
  const isAll = supplierLower === "all";

  const sh = sheet_();
  const { rows, idx } = read_(sh);

  mustHave_(idx, [H.customer, H.supplier, H.carrier, H.trackingNumber, H.trackingLink]);
  mustHave_(idx, [H.dropOrder, H.surfOrder, H.completed]);

  const hasMailCustomer = idx[H.mailCustomer] !== undefined;

  const supplierMailMap = buildSupplierMailMap_();
  const supplierKeyMap = buildSupplierKeyMap_();

  const orders = [];
  for (let i = 0; i < rows.length; i++) {
    const row = rows[i];
    const rowSupplier = String(row[idx[H.supplier]] || "").trim();

    if (!isAll && rowSupplier.toLowerCase() !== supplierLower) continue;

    const customer = String(row[idx[H.customer]] || "").trim();
    if (!customer && !rowSupplier) continue;

    const completedRaw = String(row[idx[H.completed]] || "").trim().toUpperCase();
    const completed = (completedRaw === "TRUE" || completedRaw === "YES" || completedRaw === "1");

    orders.push({
      rowId: i + 2,

      Customer: customer,
      Supplier: rowSupplier,

      "Mail Customer": hasMailCustomer ? String(row[idx[H.mailCustomer]] || "").trim() : "",

      "Dropshipment order": String(row[idx[H.dropOrder]] || "").trim(),
      "Surfcenter order": String(row[idx[H.surfOrder]] || "").trim(),

      Carrier: String(row[idx[H.carrier]] || "").trim(),
      Trackingnumber: String(row[idx[H.trackingNumber]] || "").trim(),
      Trackinglink: String(row[idx[H.trackingLink]] || "").trim(),

      "Mail Supplier": supplierMailMap[rowSupplier.toLowerCase()] || "",
      "Supplier KEY": supplierKeyMap[rowSupplier.toLowerCase()] || "",

      Completed: completed,
    });
  }

  return output_({ ok: true, orders }, e);
}

/* =========================
 * UPDATE TRACKING
 * ========================= */
function updateTrackingGet_(e) {
  const rowId = Number(e?.parameter?.rowId);
  const supplier = String(e?.parameter?.supplier || "").trim();
  const supplierKey = String(e?.parameter?.supplierKey || "").trim();

  if (!rowId || rowId < 2) return output_({ ok: false, error: "Invalid rowId" }, e);
  if (!supplier || !supplierKey) return output_({ ok: false, error: "Missing supplier or supplierKey" }, e);

  const Carrier = String(e?.parameter?.Carrier || "").trim();
  const Trackingnumber = String(e?.parameter?.Trackingnumber || "").trim();
  const Trackinglink = String(e?.parameter?.Trackinglink || "").trim();
  if (!Carrier || !Trackingnumber || !Trackinglink) return output_({ ok: false, error: "Missing tracking fields" }, e);

  const isMaster = supplierKey === MASTER_KEY;

  const sh = sheet_();
  const { idx } = read_(sh);
  mustHave_(idx, [H.supplier, H.carrier, H.trackingNumber, H.trackingLink]);

  if (!isMaster) {
    const sheetSupplier = String(sh.getRange(rowId, idx[H.supplier] + 1).getValue() || "").trim().toLowerCase();
    if (sheetSupplier !== supplier.toLowerCase()) return output_({ ok: false, error: "Unauthorized" }, e);

    const expectedKey = findKeyBySupplier_(supplier);
    if (!expectedKey || expectedKey !== supplierKey) return output_({ ok: false, error: "Unauthorized" }, e);
  }

  sh.getRange(rowId, idx[H.carrier] + 1).setValue(Carrier);
  sh.getRange(rowId, idx[H.trackingNumber] + 1).setValue(Trackingnumber);
  sh.getRange(rowId, idx[H.trackingLink] + 1).setValue(Trackinglink);

  return output_({ ok: true }, e);
}

/* =========================
 * CREATE ORDER (MASTER ONLY)
 * ========================= */
function createOrderGet_(e) {
  const supplierKey = String(e?.parameter?.supplierKey || "").trim();
  if (supplierKey !== MASTER_KEY) return output_({ ok: false, error: "Unauthorized" }, e);

  const Customer = String(e?.parameter?.Customer || "").trim();
  const MailCustomer = String(e?.parameter?.MailCustomer || "").trim();
  const Supplier = String(e?.parameter?.Supplier || "").trim();
  const DropshipmentOrder = String(e?.parameter?.DropshipmentOrder || "").trim();
  const SurfcenterOrder = String(e?.parameter?.SurfcenterOrder || "").trim();

  if (!Customer || !MailCustomer || !Supplier || !DropshipmentOrder || !SurfcenterOrder) {
    return output_({ ok: false, error: "Missing fields" }, e);
  }

  const sh = sheet_();
  const { idx } = read_(sh);

  mustHave_(idx, [H.customer, H.mailCustomer, H.supplier, H.dropOrder, H.surfOrder, H.completed]);

  const lastCol = sh.getLastColumn();
  const newRow = new Array(lastCol).fill("");

  newRow[idx[H.customer]] = Customer;
  newRow[idx[H.mailCustomer]] = MailCustomer;
  newRow[idx[H.supplier]] = Supplier;
  newRow[idx[H.dropOrder]] = DropshipmentOrder;
  newRow[idx[H.surfOrder]] = SurfcenterOrder;

  if (idx[H.supplierKey] !== undefined) {
    const k = findKeyBySupplier_(Supplier);
    if (k) newRow[idx[H.supplierKey]] = k;
  }

  newRow[idx[H.completed]] = "FALSE";

  sh.appendRow(newRow);
  return output_({ ok: true }, e);
}

/* =========================
 * COMPLETED (MASTER ONLY)
 * ========================= */
function setCompletedGet_(e) {
  const supplierKey = String(e?.parameter?.supplierKey || "").trim();
  if (supplierKey !== MASTER_KEY) return output_({ ok: false, error: "Unauthorized" }, e);

  const rowId = Number(e?.parameter?.rowId);
  if (!rowId || rowId < 2) return output_({ ok: false, error: "Invalid rowId" }, e);

  const CompletedRaw = String(e?.parameter?.Completed ?? e?.parameter?.completed ?? "")
    .trim()
    .toUpperCase();

  if (CompletedRaw !== "TRUE" && CompletedRaw !== "FALSE") {
    return output_({ ok: false, error: "Completed must be TRUE or FALSE" }, e);
  }

  const sh = sheet_();
  const { idx } = read_(sh);
  mustHave_(idx, [H.completed]);

  sh.getRange(rowId, idx[H.completed] + 1).setValue(CompletedRaw);
  return output_({ ok: true }, e);
}

/* =========================
 * TEMPLATES
 * Sheet: ID | Language | Label | Subject | Body
 * ========================= */
function listTemplates_(e, sheetName) {
  mustBeMaster_(e);

  const sh = SpreadsheetApp.getActive().getSheetByName(sheetName);
  if (!sh) throw new Error(`Sheet not found: ${sheetName}`);

  const values = sh.getDataRange().getValues();
  if (values.length < 2) return output_({ ok: true, templates: [] }, e);

  const hdr = values[0].map(String);
  const idx = indexMap_(hdr);

  const need = ["ID", "Language", "Label", "Subject", "Body"];
  for (const h of need) if (idx[h] === undefined) throw new Error(`Missing column header in "${sheetName}": ${h}`);

  const templates = [];
  for (let i = 1; i < values.length; i++) {
    const r = values[i];
    const id = String(r[idx["ID"]] || "").trim();
    const language = String(r[idx["Language"]] || "").trim().toLowerCase();
    const label = String(r[idx["Label"]] || "").trim();
    const subject = String(r[idx["Subject"]] || "").trim();
    const body = String(r[idx["Body"]] || "").trim();
    if (!id || !language || !label) continue;
    templates.push({ id, language, label, subject, body });
  }

  return output_({ ok: true, templates }, e);
}

function upsertTemplate_(e, sheetName, maxCount /* number|null */) {
  mustBeMaster_(e);

  const sh = SpreadsheetApp.getActive().getSheetByName(sheetName);
  if (!sh) throw new Error(`Sheet not found: ${sheetName}`);

  const values = sh.getDataRange().getValues();
  if (values.length < 1) throw new Error(`Sheet is empty: ${sheetName}`);

  const hdr = values[0].map(String);
  const idx = indexMap_(hdr);

  const need = ["ID", "Language", "Label", "Subject", "Body"];
  for (const h of need) if (idx[h] === undefined) throw new Error(`Missing column header in "${sheetName}": ${h}`);

  const idParam = String(e?.parameter?.id || "").trim();
  const language = String(e?.parameter?.language || "").trim().toLowerCase();
  const label = String(e?.parameter?.label || "").trim();
  const subject = String(e?.parameter?.subject || "").trim();
  const body = String(e?.parameter?.body || "").trim();

  if (!language) return output_({ ok: false, error: "Missing language" }, e);
  if (!label) return output_({ ok: false, error: "Missing label" }, e);

  let foundRow = 0; // 1-based
  if (idParam) {
    for (let r = 2; r <= values.length; r++) {
      const cur = String(values[r - 1][idx["ID"]] || "").trim();
      if (cur === idParam) { foundRow = r; break; }
    }
  }

  // enforce max for independent templates
  if (!foundRow && typeof maxCount === "number") {
    let count = 0;
    for (let i = 1; i < values.length; i++) {
      if (String(values[i][idx["ID"]] || "").trim()) count++;
    }
    if (count >= maxCount) return output_({ ok:false, error:`Max ${maxCount} templates reached` }, e);
  }

  const id = foundRow ? idParam : Utilities.getUuid();

  if (!foundRow) {
    const newRow = new Array(sh.getLastColumn()).fill("");
    newRow[idx["ID"]] = id;
    newRow[idx["Language"]] = language;
    newRow[idx["Label"]] = label;
    newRow[idx["Subject"]] = subject;
    newRow[idx["Body"]] = body;
    sh.appendRow(newRow);
    return output_({ ok: true, id, mode: "insert" }, e);
  }

  sh.getRange(foundRow, idx["Language"] + 1).setValue(language);
  sh.getRange(foundRow, idx["Label"] + 1).setValue(label);
  sh.getRange(foundRow, idx["Subject"] + 1).setValue(subject);
  sh.getRange(foundRow, idx["Body"] + 1).setValue(body);

  return output_({ ok: true, id, mode: "update" }, e);
}

/* =========================
 * MAIL LOG
 * Sheet: Timestamp | RowID | Customer | OrderID | To | Kind | Language | Template | Subject
 * ========================= */
function logMail_(e) {
  mustBeMaster_(e);

  const sh = SpreadsheetApp.getActive().getSheetByName(MAIL_LOG_SHEET);
  if (!sh) throw new Error(`Sheet not found: ${MAIL_LOG_SHEET}`);

  const { idx } = read_(sh);
  const need = ["Timestamp","RowID","Customer","OrderID","To","Kind","Language","Template","Subject"];
  for (const h of need) if (idx[h] === undefined) throw new Error(`Missing column header in "${MAIL_LOG_SHEET}": ${h}`);

  const RowID = String(e?.parameter?.RowID || "").trim();
  if (!RowID) return output_({ ok:false, error:"Missing RowID" }, e);

  const Customer = String(e?.parameter?.Customer || "").trim();
  const OrderID = String(e?.parameter?.OrderID || "").trim();
  const To = String(e?.parameter?.To || "").trim();
  const Kind = String(e?.parameter?.Kind || "").trim();
  const Language = String(e?.parameter?.Language || "").trim();
  const Template = String(e?.parameter?.Template || "").trim();
  const Subject = String(e?.parameter?.Subject || "").trim();

  const newRow = new Array(sh.getLastColumn()).fill("");
  newRow[idx["Timestamp"]] = new Date();
  newRow[idx["RowID"]] = RowID;
  newRow[idx["Customer"]] = Customer;
  newRow[idx["OrderID"]] = OrderID;
  newRow[idx["To"]] = To;
  newRow[idx["Kind"]] = Kind;
  newRow[idx["Language"]] = Language;
  newRow[idx["Template"]] = Template;
  newRow[idx["Subject"]] = Subject;

  sh.appendRow(newRow);
  return output_({ ok:true }, e);
}

function listMailLog_(e) {
  mustBeMaster_(e);

  const sh = SpreadsheetApp.getActive().getSheetByName(MAIL_LOG_SHEET);
  if (!sh) throw new Error(`Sheet not found: ${MAIL_LOG_SHEET}`);

  const RowID = String(e?.parameter?.RowID || "").trim();
  if (!RowID) return output_({ ok:false, error:"Missing RowID" }, e);

  const values = sh.getDataRange().getValues();
  if (values.length < 2) return output_({ ok:true, rows: [] }, e);

  const hdr = values[0].map(String);
  const idx = indexMap_(hdr);
  const need = ["Timestamp","RowID","Template","Subject"];
  for (const h of need) if (idx[h] === undefined) throw new Error(`Missing column header in "${MAIL_LOG_SHEET}": ${h}`);

  const out = [];
  for (let i = values.length - 1; i >= 1; i--) {
    const r = values[i];
    if (String(r[idx["RowID"]] || "").trim() !== RowID) continue;

    out.push({
      Timestamp: formatTs_(r[idx["Timestamp"]]),
      Template: String(r[idx["Template"]] || "").trim() || "-",
      Subject: String(r[idx["Subject"]] || "").trim() || "-",
    });

    if (out.length >= 50) break;
  }

  return output_({ ok:true, rows: out }, e);
}

/* =========================
 * HELPERS
 * ========================= */
function mustBeMaster_(e) {
  const supplierKey = String(e?.parameter?.supplierKey || "").trim();
  if (supplierKey !== MASTER_KEY) throw new Error("Unauthorized");
}

function sheet_() {
  const sh = SpreadsheetApp.getActive().getSheetByName(SHEET_NAME);
  if (!sh) throw new Error(`Sheet not found: ${SHEET_NAME}`);
  return sh;
}

function suppliersSheet_() {
  const sh = SpreadsheetApp.getActive().getSheetByName(SUPPLIERS_SHEET);
  if (!sh) throw new Error(`Sheet not found: ${SUPPLIERS_SHEET}`);
  return sh;
}

function read_(sh) {
  const values = sh.getDataRange().getValues();
  const headers = values[0].map(String);
  const rows = values.slice(1);
  const idx = {};
  headers.forEach((h, i) => (idx[h] = i));
  return { headers, rows, idx };
}

function mustHave_(idx, headers) {
  for (const h of headers) if (idx[h] === undefined) throw new Error(`Missing column header: ${h}`);
}

function indexMap_(headers) {
  const idx = {};
  headers.forEach((h,i)=> idx[String(h)] = i);
  return idx;
}

function output_(obj, e) {
  const json = JSON.stringify(obj);
  const cb = e && e.parameter && e.parameter.callback ? String(e.parameter.callback) : "";
  const body = cb ? `${cb}(${json});` : json;

  const out = ContentService.createTextOutput(body);
  out.setMimeType(cb ? ContentService.MimeType.JAVASCRIPT : ContentService.MimeType.JAVASCRIPT);
  return out;
}

function formatTs_(v) {
  if (!v) return "";
  try {
    const d = (v instanceof Date) ? v : new Date(v);
    return Utilities.formatDate(d, Session.getScriptTimeZone(), "yyyy-MM-dd HH:mm:ss");
  } catch(_) {
    return String(v);
  }
}

/* Suppliers */
function findSupplierByKey_(key) {
  const sh = suppliersSheet_();
  const values = sh.getDataRange().getValues();
  for (let i = 1; i < values.length; i++) {
    const supplier = String(values[i][0] || "").trim(); // A
    const k = String(values[i][2] || "").trim();        // C
    if (k && k === key && supplier) return supplier;
  }
  return "";
}

function findKeyBySupplier_(supplierName) {
  const needle = String(supplierName || "").trim().toLowerCase();
  if (!needle) return "";

  const sh = suppliersSheet_();
  const values = sh.getDataRange().getValues();
  for (let i = 1; i < values.length; i++) {
    const supplier = String(values[i][0] || "").trim().toLowerCase(); // A
    const k = String(values[i][2] || "").trim();                      // C
    if (supplier && supplier === needle && k) return k;
  }
  return "";
}

function buildSupplierMailMap_() {
  const sh = suppliersSheet_();
  const values = sh.getDataRange().getValues();
  const map = {};
  for (let i = 1; i < values.length; i++) {
    const s = String(values[i][0] || "").trim();
    const m = String(values[i][1] || "").trim();
    if (s && m) map[s.toLowerCase()] = m;
  }
  return map;
}

function buildSupplierKeyMap_() {
  const sh = suppliersSheet_();
  const values = sh.getDataRange().getValues();
  const map = {};
  for (let i = 1; i < values.length; i++) {
    const s = String(values[i][0] || "").trim();
    const k = String(values[i][2] || "").trim();
    if (s && k) map[s.toLowerCase()] = k;
  }
  return map;
}
