

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Delivery Overview ðŸ“¦</title>

<style>
:root{--bg:#0b1220;--card:#111a2e;--text:#e7eeff;--muted:#93a4c7;--acc:#4f8cff;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text)}
.wrap{max-width:1100px;margin:0 auto;padding:22px 14px}
.card{background:var(--card);border:1px solid rgba(34,49,88,.8);border-radius:16px;padding:14px}
.row{display:flex;gap:10px;align-items:center}
.hidden{display:none!important}
.btn{border:1px solid rgba(34,49,88,.9);background:#0f1730;color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
.btn.primary{background:linear-gradient(135deg,var(--acc),#6d5cff);border-color:transparent}
input{width:100%;background:#0d1429;border:1px solid rgba(34,49,88,.9);color:var(--text);padding:10px;border-radius:12px}
.table{width:100%;border-collapse:separate;border-spacing:0;border-radius:14px;overflow:hidden;border:1px solid rgba(34,49,88,.8)}
.table th,.table td{padding:10px 12px;border-bottom:1px solid rgba(34,49,88,.7);text-align:left}
.status{display:inline-flex;gap:6px;align-items:center;font-size:12px}
.dot{width:8px;height:8px;border-radius:50%;background:var(--warn)}
.status.ready .dot{background:var(--ok)}
.center{min-height:100vh;display:grid;place-items:center}
.muted{color:var(--muted)}
</style>
</head>

<body>

<!-- LOGIN -->
<section id="loginView" class="center">
  <div class="card" style="max-width:420px;width:100%;text-align:center">
    <h1>Delivery Overview ðŸ“¦</h1>
    <input id="keyInput" type="password" placeholder="Password" />
    <div class="row" style="justify-content:center;margin-top:12px">
      <button id="loginBtn" class="btn primary">Login</button>
      <button id="clearBtn" class="btn">Clear</button>
    </div>
    <div id="loginMsg" class="muted" style="margin-top:10px"></div>
  </div>
</section>

<!-- PORTAL -->
<section id="portalView" class="hidden">
  <div class="wrap">

    <header class="row" style="justify-content:space-between">
      <h1>Delivery Overview ðŸ“¦</h1>
      <div class="row">
        <button id="reloadBtn" class="btn">Reload</button>
        <button id="logoutBtn" class="btn">Logout</button>
      </div>
    </header>

    <div class="row" style="gap:14px;align-items:flex-start">

      <!-- LEFT -->
      <section class="card" style="flex:1">
        <div id="noSelection" class="muted">Open an order from the table.</div>

        <div id="form" class="hidden">
          <div><b id="customerLabel"></b></div>
          <div id="orderIdLabel" class="muted"></div>

          <input id="carrier" placeholder="Carrier" />
          <input id="trackingNumber" placeholder="Tracking number" />
          <input id="trackingLink" placeholder="Tracking link" />

          <div class="row" style="margin-top:10px">
            <button id="saveBtn" class="btn primary">Save</button>
            <button id="gmailDraftBtn" class="btn hidden">Mail customer</button>
            <button id="appleMailDraftBtn" class="btn hidden">Apple Mail</button>
          </div>

          <div id="msg" class="muted"></div>
        </div>
      </section>

      <!-- RIGHT -->
      <section class="card" style="flex:1">
        <table class="table">
          <thead>
            <tr>
              <th>Customer</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="3" class="muted">Loadingâ€¦</td></tr>
          </tbody>
        </table>
      </section>

    </div>
  </div>
</section>

<script>
const API_BASE="https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec";
const MASTER="ALL";
const $=id=>document.getElementById(id);

let supplier="",supplierKey="",orders=[],selected=null;

function isMaster(){return supplier.toLowerCase()===MASTER.toLowerCase();}
function escape(s){return String(s||"");}

function jsonp(url){
  return new Promise((res,rej)=>{
    const cb="cb"+Math.random().toString(36).slice(2);
    window[cb]=d=>{delete window[cb];res(d);}
    const s=document.createElement("script");
    s.src=url+"&callback="+cb;
    s.onerror=()=>rej();
    document.head.appendChild(s);
  });
}

function pick(o,keys){
  for(const k of keys){if(o[k])return String(o[k]).trim();}
  return "";
}

/* LOGIN */
$("loginBtn").onclick=async()=>{
  const k=$("keyInput").value.trim();
  if(!k)return;
  const d=await jsonp(`${API_BASE}?action=auth&supplierKey=${encodeURIComponent(k)}`);
  if(!d.ok)return $("loginMsg").textContent="Invalid password";
  supplierKey=k;supplier=d.supplier;
  $("loginView").classList.add("hidden");
  $("portalView").classList.remove("hidden");
  loadOrders();
};

$("clearBtn").onclick=()=>{$("keyInput").value="";$("loginMsg").textContent="";};

/* LOAD */
async function loadOrders(){
  const url=isMaster()
    ?`${API_BASE}?action=orders&supplier=ALL&supplierKey=${supplierKey}`
    :`${API_BASE}?action=orders&supplier=${encodeURIComponent(supplier)}`;
  const d=await jsonp(url);
  orders=d.orders||[];
  render();
}

function render(){
  const tb=$("tbody");tb.innerHTML="";
  for(const o of orders){
    const ok=o.Carrier&&o.Trackingnumber&&o.Trackinglink;
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>
        <b>${escape(o.Customer)}</b>
        ${isMaster()?`<div class="muted">${escape(o.Supplier)}</div>`:""}
      </td>
      <td><span class="status ${ok?"ready":""}"><span class="dot"></span>${ok?"Complete":"Missing"}</span></td>
      <td>
        <button class="btn" onclick="openRow(${o.rowId})">Open</button>
        ${isMaster()?`<button class="btn" onclick="mailSupplier(${o.rowId})">Mail supplier</button>`:""}
      </td>`;
    tb.appendChild(tr);
  }
}

window.openRow=id=>{
  selected=orders.find(o=>o.rowId==id);
  $("customerLabel").textContent=selected.Customer;
  $("orderIdLabel").textContent=selected.OrderID||"";
  $("carrier").value=selected.Carrier||"";
  $("trackingNumber").value=selected.Trackingnumber||"";
  $("trackingLink").value=selected.Trackinglink||"";
  $("form").classList.remove("hidden");
  $("noSelection").classList.add("hidden");
  $("gmailDraftBtn").classList.toggle("hidden",!isMaster());
  $("appleMailDraftBtn").classList.toggle("hidden",!isMaster());
};

/* MAIL CUSTOMER */
function draftCustomer(useGmail){
  const to=pick(selected,["MailCustomer","Mail"]);
  if(!to)return alert("No customer email");
  const subject=`Tracking details â€“ Order ${selected.OrderID||""}`;
  const body=`Hi ${selected.Customer},

Carrier: ${selected.Carrier||""}
Tracking number: ${selected.Trackingnumber||""}
Tracking link: ${selected.Trackinglink||""}`;
  const url=useGmail
    ?`https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(to)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`
    :`mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  window.open(url,"_blank");
}

$("gmailDraftBtn").onclick=()=>draftCustomer(true);
$("appleMailDraftBtn").onclick=()=>draftCustomer(false);

/* MAIL SUPPLIER */
window.mailSupplier=id=>{
  const o=orders.find(x=>x.rowId==id);
  const to=pick(o,["MailSupplier"]);
  if(!to)return alert("No supplier email");
  const subject=`Tracking needed â€“ Order ${o.OrderID||""}`;
  const body=`Hi ${o.Supplier},

Please provide:
- Carrier
- Tracking number
- Tracking link`;
  window.open(
    `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(to)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`,
    "_blank"
  );
};

$("reloadBtn").onclick=loadOrders;
$("logoutBtn").onclick=()=>location.reload();
</script>

</body>
</html>
